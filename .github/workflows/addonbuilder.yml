name: Create Add-on Release

on:
  push:
    tags:
      - '*'

jobs:
  create-release:
    name: Version ${{ github.ref_name }}
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true
          ref: ${{ github.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install git+https://github.com/glutanimate/anki-addon-builder.git@4039b5bb743773a18cb2911e6dd38fa1e3f65982
          python -m pip install pyqt5

      - name: Setup git config
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

      - name: Build .ankiaddon package
        run: aab build -d ankiweb

      - name: Declare variables
        id: vars
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "module_name=$(basename src/*)" >> $GITHUB_OUTPUT
          echo "build_name=$(basename build/*.ankiaddon)" >> $GITHUB_OUTPUT

          # Extract version number without 'v'
          version="${{ github.ref_name }}"
          version_no_prefix="${version#v}"
          echo "version_no_prefix=${version_no_prefix}" >> $GITHUB_OUTPUT

      - name: Get changelog for this version
        id: changelog
        run: |
          version_no_prefix="${{ steps.vars.outputs.version_no_prefix }}"
          changelog_file="assets/changelogs/${version_no_prefix}.md"

          if [[ -f "$changelog_file" ]]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            {
              echo "content<<EOF"
              cat "$changelog_file"
              echo "EOF"
            } >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Get previous tag
        id: prev
        uses: WyriHaximus/github-action-get-previous-tag@v1
        with:
          fallback: '0.0.0'

      - name: Generate release body
        id: body
        run: |
          if [[ "${{ steps.changelog.outputs.exists }}" == "true" ]]; then
            echo "text<<EOF" >> $GITHUB_OUTPUT
            echo "${{ steps.changelog.outputs.content }}" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "---" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.prev.outputs.tag }}...${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "text<<EOF" >> $GITHUB_OUTPUT
            echo "No changelog available for this release." >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "---" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_OUTPUT
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${{ steps.prev.outputs.tag }}...${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "${{ steps.vars.outputs.module_name }} v${{ github.ref_name }}"
          body: ${{ steps.body.outputs.text }}
          files: build/*.ankiaddon
          draft: true
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
